<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LegalCopilot - Working PDF Highlighter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
        
        .header {
            background: white; padding: 20px; text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;
        }
        
        .container {
            display: flex; height: calc(100vh - 100px);
        }
        
        .left-panel {
            width: 20%; background: white; padding: 20px;
            border-right: 1px solid #ddd; overflow-y: auto;
            flex-shrink: 0; /* Prevent shrinking */
        }
        
        .main-panel {
            width: 50%; background: white; padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #ddd;
            flex-shrink: 0; /* Prevent shrinking */
        }
        
        .right-panel {
            width: 30%; background: white; padding: 20px;
            border-left: 1px solid #ddd;
            flex-shrink: 0; /* Prevent shrinking */
        }
        
        .upload-section {
            text-align: center; padding: 40px;
        }
        
        .file-input {
            display: block; margin: 20px auto; padding: 12px;
            font-size: 16px; width: 300px;
        }
        
        .btn {
            background: #6366f1; color: white; padding: 12px 24px;
            border: none; border-radius: 6px; cursor: pointer;
        }
        
        .clause-item {
            padding: 12px; margin-bottom: 8px; background: #f9f9f9;
            border-radius: 6px; cursor: pointer; border-left: 4px solid #ddd;
        }
        
        .clause-item:hover { background: #f0f0f0; }
        .clause-item.active { background: #e0e7ff; }
        .clause-item.high { 
            border-left-color: #ef4444; 
            background: rgba(239, 68, 68, 0.05);
        }
        .clause-item.medium { 
            border-left-color: #f97316; 
            background: rgba(249, 115, 22, 0.05);
        }
        .clause-item.low { 
            border-left-color: #22c55e; 
            background: rgba(34, 197, 94, 0.05);
        }
        
        .document-content { 
            background: white; padding: 20px; 
            border-radius: 8px; line-height: 1.6;
        }
        
        .page { 
            margin-bottom: 30px; 
            padding: 25px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 850px; /* Match PDF page proportions */
            page-break-after: always;
            position: relative;
        }
        .page-header { 
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); 
            color: white;
            padding: 15px 20px; 
            border-radius: 8px; 
            margin-bottom: 25px; 
            font-weight: bold;
            text-align: center;
            font-size: 1.1em;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        }
        
        /* RED FLAG HIGHLIGHTING SYSTEM - EXACT SPECS */
        .highlight-high { 
            background: rgba(239, 68, 68, 0.25); 
            padding: 3px 6px; 
            border-radius: 4px;
            border-left: 4px solid #ef4444;
            box-shadow: 0 1px 3px rgba(239, 68, 68, 0.3);
            font-weight: 500;
        }
        .highlight-medium { 
            background: rgba(249, 115, 22, 0.2); 
            padding: 3px 6px; 
            border-radius: 4px;
            border-left: 4px solid #f97316;
            box-shadow: 0 1px 3px rgba(249, 115, 22, 0.3);
        }
        .highlight-low { 
            background: rgba(34, 197, 94, 0.15); 
            padding: 3px 6px; 
            border-radius: 4px;
            border-left: 4px solid #22c55e;
            box-shadow: 0 1px 3px rgba(34, 197, 94, 0.3);
        }
        
        /* AI-enhanced highlighting */
        .ai-enhanced { border-left: 3px solid #6366f1; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .ai-detected { 
            border: 2px solid #6366f1; 
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
            animation: aiPulse 2s ease-in-out;
        }
        
        /* Article headers - more prominent highlighting */
        .article-header {
            font-weight: bold !important;
            font-size: 1.1em !important;
            border: 3px solid #6366f1 !important;
            padding: 6px 12px !important;
            border-radius: 6px !important;
            background: rgba(99, 102, 241, 0.1) !important;
        }
        
        /* Clause content - subtle highlighting */
        .clause-content {
            border: 1px solid #6366f1 !important;
            padding: 3px 6px !important;
            border-radius: 3px !important;
            background: rgba(99, 102, 241, 0.05) !important;
        }
        
        @keyframes aiPulse {
            0% { box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2); }
            50% { box-shadow: 0 4px 8px rgba(99, 102, 241, 0.4); }
            100% { box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2); }
        }
        
        .clause-details { background: #f9f9f9; padding: 15px; border-radius: 6px; margin-bottom: 15px; }
        
        /* ENHANCED VISUAL FEEDBACK - 2 SECOND FLASH EFFECTS (EXACT SPECS) */
        .clause-flash {
            animation: flashHighlight 2s ease-in-out;
            border: 3px solid #6366f1 !important;
            border-radius: 6px !important;
            padding: 6px 12px !important;
            margin: 4px 0 !important;
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.4) !important;
        }
        
        /* HIGH RISK flash effect */
        .clause-flash.high {
            border-color: #ef4444 !important;
            animation: flashHighRisk 2s ease-in-out;
        }
        
        /* MEDIUM RISK flash effect */
        .clause-flash.medium {
            border-color: #f97316 !important;
            animation: flashMediumRisk 2s ease-in-out;
        }
        
        /* LOW RISK flash effect */
        .clause-flash.low {
            border-color: #22c55e !important;
            animation: flashLowRisk 2s ease-in-out;
        }
        
        @keyframes flashHighlight {
            0% { background: rgba(99, 102, 241, 0.4); transform: scale(1.03); }
            25% { background: rgba(99, 102, 241, 0.3); transform: scale(1.02); }
            75% { background: rgba(99, 102, 241, 0.2); transform: scale(1.01); }
            100% { background: transparent; transform: scale(1); }
        }
        
        @keyframes flashHighRisk {
            0% { background: rgba(239, 68, 68, 0.4); transform: scale(1.03); box-shadow: 0 6px 12px rgba(239, 68, 68, 0.5); }
            25% { background: rgba(239, 68, 68, 0.3); transform: scale(1.02); }
            75% { background: rgba(239, 68, 68, 0.2); transform: scale(1.01); }
            100% { background: transparent; transform: scale(1); box-shadow: none; }
        }
        
        @keyframes flashMediumRisk {
            0% { background: rgba(249, 115, 22, 0.4); transform: scale(1.03); }
            25% { background: rgba(249, 115, 22, 0.3); transform: scale(1.02); }
            75% { background: rgba(249, 115, 22, 0.2); transform: scale(1.01); }
            100% { background: transparent; transform: scale(1); }
        }
        
        @keyframes flashLowRisk {
            0% { background: rgba(34, 197, 94, 0.3); transform: scale(1.02); }
            50% { background: rgba(34, 197, 94, 0.2); transform: scale(1.01); }
            100% { background: transparent; transform: scale(1); }
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèõÔ∏è LegalCopilot - Working PDF Highlighter</h1>
        <p>Step-by-step rebuild with basic highlighting</p>
    </div>

    <div id="uploadSection" class="upload-section">
        <h2>Upload PDF File</h2>
        <input type="file" id="fileInput" class="file-input" accept=".pdf" />
        <button id="processBtn" class="btn">Process PDF with Basic Highlighting</button>
    </div>

    <div id="mainLayout" class="container hidden">
        <div class="left-panel">
            <h3>Contract Clauses</h3>
            <div id="clausesList">
                <div class="clause-item high" data-clause="governance">
                    <div><strong>Governance Compromise</strong></div>
                    <div style="font-size: 0.9em; color: #666;">Article 2.1 ‚Ä¢ HIGH RISK</div>
                </div>
                <div class="clause-item medium" data-clause="noncompete">
                    <div><strong>Non-Compete</strong></div>
                    <div style="font-size: 0.9em; color: #666;">Article 7.1-7.2 ‚Ä¢ MEDIUM</div>
                </div>
                <div class="clause-item high" data-clause="dragalong">
                    <div><strong>Drag Along Right</strong></div>
                    <div style="font-size: 0.9em; color: #666;">Article 4.1 ‚Ä¢ HIGH RISK</div>
                </div>
                <div class="clause-item low" data-clause="tagalong">
                    <div><strong>Tag Along Right</strong></div>
                    <div style="font-size: 0.9em; color: #666;">Article 3.6 ‚Ä¢ LOW RISK</div>
                </div>
                <div class="clause-item medium" data-clause="priority">
                    <div><strong>Priority Allocation</strong></div>
                    <div style="font-size: 0.9em; color: #666;">Article 5.2 ‚Ä¢ MEDIUM</div>
                </div>
            </div>
        </div>

        <div class="main-panel">
            <div class="document-content" id="documentContent">
                <!-- Converted content will appear here -->
            </div>
        </div>

        <div class="right-panel">
            <h3>Clause Details</h3>
            <div id="clauseDetails">
                <p>Click a clause on the left to view detailed analysis</p>
            </div>
        </div>
    </div>

    <script>
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // ENHANCED SEMANTIC CLAUSE DETECTION - EXACT SPECS
        const clauses = {
            governance: {
                title: 'Governance Compromise',
                article: '2.1',
                risk: 'high',
                confidence: 0.85,
                // Article number patterns - find actual article sections
                articlePattern: /^2\.1\s|article\s+2\.1|^2\.1\.|clause\s+2\.1/gi,
                // Enhanced content patterns with higher precision
                contentPattern: /vote.*accordance.*president|shareholder.*vote.*instructions|governance.*board.*president|voting.*rights.*subject.*to.*president/gi,
                semanticPattern: /governance.*compromise|president.*instructions.*binding|voting.*autonomy.*restricted/gi,
                scrollTarget: null,
                context: 'This clause requires you to vote according to the President\'s instructions, limiting your autonomy.',
                implication: 'Loss of independent decision-making power'
            },
            dragalong: {
                title: 'Drag Along Right',
                article: '1.5', 
                risk: 'high',
                confidence: 0.92,
                // Look for Article 1.5 specifically
                articlePattern: /^1\.5\s|article\s+1\.5|^1\.5\.|clause\s+1\.5/gi,
                // Enhanced drag-along detection
                contentPattern: /drag.along.*right|ninety.five.*percent|95%.*sharehold|offeror.*require.*sell|force.*sale.*shares/gi,
                semanticPattern: /drag.*along.*provision|majority.*force.*minority|compulsory.*sale.*mechanism/gi,
                scrollTarget: null,
                context: 'If 95% of shareholders agree to sell, you must sell your shares.',
                implication: 'You can be forced to sell against your wishes'
            },
            tagalong: {
                title: 'Tag Along Right',
                article: '3.6',
                risk: 'low',
                confidence: 0.78,
                articlePattern: /^3\.6\s|article\s+3\.6|^3\.6\.|clause\s+3\.6/gi,
                contentPattern: /tag.along.*right|transferor.*sharehold|minority.*protection|co.sale.*right/gi,
                semanticPattern: /tag.*along.*protection|minority.*shareholder.*rights|equal.*sale.*opportunity/gi,
                scrollTarget: null,
                context: 'You can sell alongside other shareholders at the same price.',
                implication: 'Protection against being left behind in sales'
            },
            priority: {
                title: 'Priority Allocation',
                article: '5.2',
                risk: 'medium',
                confidence: 0.81,
                articlePattern: /^5\.2\s|article\s+5\.2|^5\.2\.|clause\s+5\.2/gi,
                contentPattern: /priority.*allocation|waterfall.*distribution|liquidation.*preference|proceeds.*distributed/gi,
                semanticPattern: /payment.*hierarchy|distribution.*waterfall|payout.*sequence/gi,
                scrollTarget: null,
                context: 'Defines how sale proceeds are distributed.',
                implication: 'Your payout position in the distribution hierarchy'
            },
            noncompete: {
                title: 'Non-Compete',
                article: '7.1-7.2',
                risk: 'medium',
                confidence: 0.87,
                articlePattern: /^7\.[12]\s|article\s+7\.[12]|^7\.[12]\.|clause\s+7\.[12]/gi,
                contentPattern: /non.compete.*restrictions|non.solicit.*provisions|competition.*restrictions|restraint.*trade/gi,
                semanticPattern: /competitive.*restriction|business.*limitation|post.*employment.*constraint/gi,
                scrollTarget: null,
                context: 'Non-compete restrictions remain in effect.',
                implication: 'Continued business activity restrictions'
            }
        };

        let processedContent = '';
        let maxPages = 0; // Store total pages for fallback navigation

        // AI-powered clause analysis function
        async function performAIClauseAnalysis(htmlContent) {
            try {
                // Extract text content for AI analysis
                const textContent = htmlContent.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                
                // Send to local Flask backend for AI analysis
                const response = await fetch('http://localhost:5001/analyze-clauses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        document_text: textContent.substring(0, 10000), // First 10k chars for analysis
                        clause_types: ['governance', 'drag_along', 'tag_along', 'priority_allocation', 'non_compete']
                    })
                });

                if (response.ok) {
                    const aiResults = await response.json();
                    console.log('üéØ AI detected clauses:', aiResults.detected_clauses);
                    
                    // Enhance highlighting with AI results
                    return enhanceHighlightingWithAI(htmlContent, aiResults);
                } else {
                    throw new Error('AI analysis service unavailable');
                }
                
            } catch (error) {
                console.error('AI analysis error:', error);
                // Fallback to enhanced pattern matching
                return performSmartPatternAnalysis(htmlContent);
            }
        }

        // Enhanced pattern-based analysis (fallback)
        function performSmartPatternAnalysis(htmlContent) {
            console.log('üìä Using enhanced pattern analysis');
            
            // More sophisticated patterns for legal clauses
            const enhancedPatterns = {
                governance: [
                    /vote.*accordance.*president/gi,
                    /governance.*compromise/gi,
                    /instructions.*provided.*president/gi,
                    /voting.*rights.*subject.*to/gi
                ],
                drag_along: [
                    /drag.along.*right/gi,
                    /ninety.five.*per.*cent|95%/gi,
                    /offeror.*may.*require/gi,
                    /forced.*sale.*shares/gi,
                    /purchase.*all.*shares/gi
                ],
                tag_along: [
                    /tag.along.*right/gi,
                    /transferor.*shareholder/gi,
                    /sell.*alongside/gi,
                    /same.*price.*terms/gi
                ],
                priority_allocation: [
                    /priority.*allocation/gi,
                    /sale.*price.*allocated/gi,
                    /waterfall.*distribution/gi,
                    /proceeds.*distributed/gi
                ],
                non_compete: [
                    /non.compete|non.solicit/gi,
                    /restrictions.*remain.*applicable/gi,
                    /avoidance.*doubts/gi,
                    /freed.*non.compete/gi
                ]
            };

            let enhancedContent = htmlContent;
            
            Object.entries(enhancedPatterns).forEach(([clauseType, patterns]) => {
                const clause = Object.values(clauses).find(c => c.title.toLowerCase().includes(clauseType.replace('_', ' ')));
                if (!clause) return;
                
                patterns.forEach(pattern => {
                    enhancedContent = enhancedContent.replace(pattern, (match) => {
                        return `<span class="highlight-${clause.risk} ai-enhanced" title="AI detected: ${clause.title}">${match}</span>`;
                    });
                });
            });
            
            return enhancedContent;
        }

        // Enhance highlighting with AI results
        function enhanceHighlightingWithAI(htmlContent, aiResults) {
            let enhancedContent = htmlContent;
            
            if (aiResults.detected_clauses) {
                aiResults.detected_clauses.forEach(detection => {
                    const text = detection.text;
                    const clauseType = detection.type;
                    const confidence = detection.confidence;
                    
                    if (confidence > 0.7) { // High confidence AI detections
                        const clause = Object.values(clauses).find(c => 
                            c.title.toLowerCase().includes(clauseType.replace('_', ' '))
                        );
                        
                        if (clause) {
                            const regex = new RegExp(text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                            enhancedContent = enhancedContent.replace(regex, 
                                `<span class="highlight-${clause.risk} ai-detected" 
                                      title="AI detected: ${clause.title} (${Math.round(confidence * 100)}% confidence)">
                                    ${text}
                                 </span>`
                            );
                        }
                    }
                });
            }
            
            return enhancedContent;
        }

        document.getElementById('processBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('fileInput');
            const uploadSection = document.getElementById('uploadSection');
            const mainLayout = document.getElementById('mainLayout');
            const documentContent = document.getElementById('documentContent');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select a PDF file first');
                return;
            }
            
            const file = fileInput.files[0];
            console.log('Processing:', file.name);
            
            try {
                documentContent.innerHTML = '<p>üîÑ Processing PDF...</p>';
                uploadSection.classList.add('hidden');
                mainLayout.classList.remove('hidden');
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                console.log('PDF loaded:', pdf.numPages, 'pages');
                
                let htmlContent = '';
                maxPages = pdf.numPages; // Store globally and process ALL pages
                
                // Process in chunks to prevent crashes
                for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
                    try {
                        console.log(`Processing page ${pageNum}/${maxPages}...`);
                        documentContent.innerHTML = `<p>üîÑ Processing page ${pageNum}/${maxPages}...</p>`;
                        
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        
                        htmlContent += `<div class="page" id="page-${pageNum}">
                            <div class="page-header">üìÑ Page ${pageNum} of ${maxPages}</div>`;
                        
                        // ENHANCED PAGE STRUCTURE - MATCH PDF EXACTLY
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        
                        // Better paragraph splitting to maintain PDF structure
                        const paragraphs = pageText.split(/(?<=\.)\s+(?=[A-Z])|\n\s*\n/).filter(p => p.trim().length > 10);
                        
                        paragraphs.forEach(paragraph => {
                            if (paragraph.trim()) {
                                let highlightedParagraph = paragraph.trim() + '.';
                                
                                // ENHANCED SEMANTIC CLAUSE DETECTION WITH CONFIDENCE SCORING
                                let foundClause = null;
                                let isArticleHeader = false;
                                let maxConfidence = 0;
                                
                                Object.entries(clauses).forEach(([clauseKey, clause]) => {
                                    let clauseConfidence = 0;
                                    
                                    // First priority: Look for article headers (e.g., "1.5", "2.1", "3.6")
                                    const articleMatches = highlightedParagraph.match(clause.articlePattern);
                                    if (articleMatches) {
                                        clauseConfidence += 0.9; // High confidence for article numbers
                                        
                                        // This is an article header - mark it for scrolling
                                        const clauseId = `article-${clauseKey}-page-${pageNum}`;
                                        clause.scrollTarget = clauseId;
                                        foundClause = clauseKey;
                                        isArticleHeader = true;
                                        
                                        // Highlight article number with confidence indicator
                                        articleMatches.forEach(match => {
                                            const regex = new RegExp(match.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                                            const confidenceLevel = clauseConfidence >= 0.8 ? 'HIGH' : clauseConfidence >= 0.6 ? 'MEDIUM' : 'LOW';
                                            highlightedParagraph = highlightedParagraph.replace(regex, 
                                                `<span class="highlight-${clause.risk} ai-detected article-header" data-clause="${clauseKey}" title="Article: ${clause.title} (${confidenceLevel} CONFIDENCE)">${match}</span>`
                                            );
                                        });
                                        
                                        console.log(`üéØ Found ARTICLE ${clause.article} on page ${pageNum} (Confidence: ${Math.round(clauseConfidence * 100)}%):`, articleMatches);
                                        return; // Priority over content matching
                                    }
                                    
                                    // Secondary: Look for clause content within paragraphs
                                    const contentMatches = highlightedParagraph.match(clause.contentPattern);
                                    if (contentMatches && !foundClause) {
                                        clauseConfidence += 0.7; // Good confidence for content matches
                                        
                                        // Check semantic patterns for additional confidence
                                        const semanticMatches = highlightedParagraph.match(clause.semanticPattern);
                                        if (semanticMatches) {
                                            clauseConfidence += 0.2; // Bonus for semantic matches
                                        }
                                        
                                        // Only highlight if confidence meets threshold (>80% as per specs)
                                        if (clauseConfidence >= 0.8) {
                                            // This paragraph contains the actual clause content
                                            const clauseId = `content-${clauseKey}-page-${pageNum}`;
                                            if (!clause.scrollTarget) { // Don't override article headers
                                                clause.scrollTarget = clauseId;
                                            }
                                            foundClause = clauseKey;
                                            maxConfidence = clauseConfidence;
                                            
                                            // Highlight clause content with confidence indicator
                                            contentMatches.forEach(match => {
                                                const regex = new RegExp(match.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                                                const confidenceLevel = clauseConfidence >= 0.9 ? 'HIGH' : clauseConfidence >= 0.8 ? 'MEDIUM' : 'LOW';
                                                highlightedParagraph = highlightedParagraph.replace(regex, 
                                                    `<span class="highlight-${clause.risk} ai-detected clause-content" data-clause="${clauseKey}" title="Content: ${clause.title} (${confidenceLevel} CONFIDENCE - ${Math.round(clauseConfidence * 100)}%)">${match}</span>`
                                                );
                                            });
                                            
                                            console.log(`üìù Found ${clauseKey} CONTENT on page ${pageNum} (Confidence: ${Math.round(clauseConfidence * 100)}%):`, contentMatches);
                                        } else {
                                            console.log(`‚ö†Ô∏è ${clauseKey} found but confidence too low (${Math.round(clauseConfidence * 100)}%) - skipping highlight`);
                                        }
                                    }
                                });
                                
                                // Set ID based on what was found
                                let paragraphId = '';
                                if (foundClause) {
                                    if (isArticleHeader) {
                                        paragraphId = `id="article-${foundClause}-page-${pageNum}"`;
                                    } else {
                                        paragraphId = `id="content-${foundClause}-page-${pageNum}"`;
                                    }
                                }
                                htmlContent += `<p ${paragraphId}>${highlightedParagraph}</p>`;
                            }
                        });
                        
                        // Add page footer for better structure
                        htmlContent += `
                            <div class="page-footer" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 0.9em; text-align: center;">
                                Page ${pageNum} ‚Ä¢ Processed with LegalCopilot
                            </div>
                        </div>`;
                        
                        // Add delay every 5 pages to prevent browser freeze
                        if (pageNum % 5 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        
                    } catch (error) {
                        console.error(`Error processing page ${pageNum}:`, error);
                        htmlContent += `<div class="page">
                            <div class="page-header">Page ${pageNum} - Error</div>
                            <p style="color: red;">Error processing this page: ${error.message}</p>
                        </div>`;
                    }
                }
                
                processedContent = htmlContent;
                
                // Add AI-powered clause analysis
                console.log('ü§ñ Starting AI clause analysis...');
                documentContent.innerHTML = '<p>ü§ñ Analyzing clauses with AI...</p>';
                
                try {
                    const aiAnalyzedContent = await performAIClauseAnalysis(htmlContent);
                    documentContent.innerHTML = aiAnalyzedContent;
                    console.log('‚úÖ AI analysis complete with enhanced highlighting');
                } catch (error) {
                    console.error('AI analysis failed, using basic highlighting:', error);
                    documentContent.innerHTML = htmlContent;
                    console.log('‚úÖ Processing complete with basic highlighting');
                }
                
            } catch (error) {
                console.error('Error:', error);
                documentContent.innerHTML = `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
            }
        });

        // Clause selection with auto-scrolling
        document.addEventListener('click', function(e) {
            if (e.target.closest('.clause-item')) {
                const clauseItem = e.target.closest('.clause-item');
                const clauseId = clauseItem.dataset.clause;
                const clause = clauses[clauseId];
                
                if (clause) {
                    // Update active state
                    document.querySelectorAll('.clause-item').forEach(item => 
                        item.classList.remove('active'));
                    clauseItem.classList.add('active');
                    
                    // Show clause details
                    document.getElementById('clauseDetails').innerHTML = `
                        <div class="clause-details">
                            <h4>${clause.title}</h4>
                            <p><strong>Article:</strong> ${clause.article}</p>
                            <p><strong>Risk Level:</strong> ${clause.risk.toUpperCase()}</p>
                            <p><strong>Context:</strong> ${clause.context}</p>
                            <p><strong>Implication:</strong> ${clause.implication}</p>
                        </div>
                    `;
                    
                    // Auto-scroll to clause location
                    scrollToClause(clauseId, clause);
                    
                    console.log('Selected clause:', clause.title);
                }
            }
        });
        
        // ENHANCED SMOOTH SCROLLING WITH FALLBACK SEARCH (EXACT SPECS)
        function scrollToClause(clauseId, clause) {
            console.log(`üéØ Scrolling to clause: ${clauseId} (${clause.title})`, clause);
            
            // PRIORITY 1: Find the actual clause by scroll target ID
            if (clause.scrollTarget) {
                console.log(`üîç Looking for element with ID: ${clause.scrollTarget}`);
                const targetElement = document.getElementById(clause.scrollTarget);
                if (targetElement) {
                    console.log(`‚úÖ Found target element, performing smooth scroll...`);
                    
                    // Enhanced smooth scrolling with 800ms duration (as per specs)
                    const documentContent = document.getElementById('documentContent');
                    const targetOffset = targetElement.offsetTop - documentContent.offsetTop;
                    const currentScroll = documentContent.scrollTop;
                    const distance = targetOffset - currentScroll;
                    
                    // Custom smooth scroll animation
                    let start = null;
                    function animateScroll(timestamp) {
                        if (!start) start = timestamp;
                        const progress = Math.min((timestamp - start) / 800, 1); // 800ms duration
                        const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                        
                        documentContent.scrollTop = currentScroll + (distance * easeOutQuart);
                        
                        if (progress < 1) {
                            requestAnimationFrame(animateScroll);
                        } else {
                            // Add visual feedback after scroll completes
                            targetElement.classList.add('clause-flash', clause.risk);
                            setTimeout(() => {
                                targetElement.classList.remove('clause-flash', clause.risk);
                            }, 2000);
                        }
                    }
                    requestAnimationFrame(animateScroll);
                    return;
                } else {
                    console.warn(`‚ùå Element with ID ${clause.scrollTarget} not found, trying fallbacks...`);
                }
            }
            
            // PRIORITY 2: Search for highlighted clause elements
            console.log(`üîç FALLBACK 1: Searching for elements with data-clause="${clauseId}"`);
            const highlightedElements = document.querySelectorAll(`[data-clause="${clauseId}"]`);
            console.log(`Found ${highlightedElements.length} highlighted elements`);
            
            if (highlightedElements.length > 0) {
                console.log(`‚úÖ FALLBACK 1 SUCCESS: Scrolling to first highlighted element`);
                const targetElement = highlightedElements[0];
                
                // Enhanced smooth scroll for fallback
                const documentContent = document.getElementById('documentContent');
                const targetOffset = targetElement.offsetTop - documentContent.offsetTop;
                const currentScroll = documentContent.scrollTop;
                const distance = targetOffset - currentScroll;
                
                let start = null;
                function animateScroll(timestamp) {
                    if (!start) start = timestamp;
                    const progress = Math.min((timestamp - start) / 800, 1);
                    const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                    
                    documentContent.scrollTop = currentScroll + (distance * easeOutQuart);
                    
                    if (progress < 1) {
                        requestAnimationFrame(animateScroll);
                    } else {
                        // Add visual feedback to all highlighted instances
                        highlightedElements.forEach(el => {
                            el.classList.add('clause-flash', clause.risk);
                            setTimeout(() => {
                                el.classList.remove('clause-flash', clause.risk);
                            }, 2000);
                        });
                    }
                }
                requestAnimationFrame(animateScroll);
                return;
            }
            
            // PRIORITY 3: Fallback search by article number (EXACT SPECS)
            console.log(`üîç FALLBACK 2: Searching for article number "${clause.article}"`);
            const allParagraphs = document.querySelectorAll('.document-content p');
            let found = false;
            
            // Enhanced article number search patterns
            const articleSearchPatterns = [
                new RegExp(`^\\s*${clause.article.replace('.', '\\.')}\\s`, 'i'),
                new RegExp(`article\\s+${clause.article.replace('.', '\\.')}`, 'i'),
                new RegExp(`section\\s+${clause.article.replace('.', '\\.')}`, 'i'),
                new RegExp(`clause\\s+${clause.article.replace('.', '\\.')}`, 'i'),
                new RegExp(clause.article.replace('.', '\\.'), 'i')
            ];
            
            allParagraphs.forEach((p, index) => {
                if (!found) {
                    const text = p.textContent.trim();
                    const hasArticleMatch = articleSearchPatterns.some(pattern => pattern.test(text));
                    
                    if (hasArticleMatch) {
                        console.log(`‚úÖ FALLBACK 2 SUCCESS: Found article ${clause.article} in paragraph ${index}`);
                        
                        // Enhanced smooth scroll for article search
                        const documentContent = document.getElementById('documentContent');
                        const targetOffset = p.offsetTop - documentContent.offsetTop;
                        const currentScroll = documentContent.scrollTop;
                        const distance = targetOffset - currentScroll;
                        
                        let start = null;
                        function animateScroll(timestamp) {
                            if (!start) start = timestamp;
                            const progress = Math.min((timestamp - start) / 800, 1);
                            const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                            
                            documentContent.scrollTop = currentScroll + (distance * easeOutQuart);
                            
                            if (progress < 1) {
                                requestAnimationFrame(animateScroll);
                            } else {
                                p.classList.add('clause-flash', clause.risk);
                                setTimeout(() => {
                                    p.classList.remove('clause-flash', clause.risk);
                                }, 2000);
                            }
                        }
                        requestAnimationFrame(animateScroll);
                        found = true;
                    }
                }
            });
            
            // PRIORITY 4: Ultimate fallback - navigate to likely page
            if (!found) {
                console.warn(`‚ö†Ô∏è FALLBACK 3: Could not find article ${clause.article}, trying page-based navigation...`);
                
                // Estimate which page the article might be on based on article number
                let estimatedPage = 1;
                const articleNum = parseFloat(clause.article);
                if (!isNaN(articleNum)) {
                    estimatedPage = Math.max(1, Math.min(Math.ceil(articleNum * 2), maxPages || 10));
                }
                
                const pageElement = document.getElementById(`page-${estimatedPage}`);
                if (pageElement) {
                    console.log(`‚úÖ FALLBACK 3: Navigating to estimated page ${estimatedPage}`);
                    pageElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    pageElement.classList.add('clause-flash', 'medium');
                    setTimeout(() => {
                        pageElement.classList.remove('clause-flash', 'medium');
                    }, 2000);
                } else {
                    console.error(`‚ùå ALL FALLBACKS FAILED: Could not find any scroll target for clause: ${clauseId}`);
                    // Show user notification
                    const notification = document.createElement('div');
                    notification.innerHTML = `‚ö†Ô∏è Could not locate ${clause.title} (Article ${clause.article}) in document`;
                    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #f97316; color: white; padding: 12px 20px; border-radius: 8px; z-index: 1000; font-weight: bold;';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);
                }
            }
        }
        
        console.log('üöÄ Working PDF highlighter ready');
    </script>
</body>
</html>